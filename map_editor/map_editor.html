<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Map Editor</title>
<style>
  body { font-family: sans-serif; display: flex; flex-direction: column; align-items: flex-start; gap: 20px; margin: 20px; }
  #setup { display: flex; flex-direction: column; gap: 10px; }
  #toolbar { display: none; flex-direction: column; gap: 10px; }
  #map { display: grid; border: 1px solid #aaa; margin-top: 10px; }
  .tile { border: 1px solid #ddd; background-size: cover; }
  #tilePreview { border: 2px solid #000; background-size: cover; }
  textarea { width: 300px; }
</style>
</head>
<body>

<!-- ✅ MAP SETUP STEP -->
<div id="setup">
  <label>Map Name: <input type="text" id="mapName" value="Thornwood"></label>
  <label>Width (tiles): <input type="number" id="mapWidth" value="8" min="4" max="100"></label>
  <label>Height (tiles): <input type="number" id="mapHeight" value="8" min="4" max="100"></label>
  <label>Preview Size (px): <input type="number" id="previewSize" value="64" min="4" max="256"></label>
  <label>Map:
    <select id="tileset">
      <option value="thornwood">Thornwood</option>
      <option value="desert">Desert</option>
      <option value="frostveil">Frostveil</option>
    </select>
  </label>
  <button id="startEditing">Start Editing</button>
</div>

<!-- ✅ TOOLBAR & MAP -->
<div id="toolbar">
  <h3 id="mapTitle"></h3>
  <select id="blockType"></select>
  <div id="tilePreview"></div>
  <button id="export">Export JSON</button>
  <textarea id="output" rows="10" cols="20" readonly></textarea>
</div>

<div id="map"></div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
  $(async function() {
  const TILESETS = await fetch('/api/maps').then(r => r.json());
  const baseURL = window.location.origin;

  $('#tileset').empty();
  for (const key of Object.keys(TILESETS)) {
    const label = key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    $('#tileset').append(`<option value="${key}">${label}</option>`);
  }

  let map = []; // ✅ single array of {x, y, tile}
  let selectedTileset = null;
  let tileSize = 64;

  $('#startEditing').on('click', () => {
    const width = parseInt($('#mapWidth').val());
    const height = parseInt($('#mapHeight').val());
    tileSize = parseInt($('#previewSize').val());
    const name = $('#mapName').val();
    selectedTileset = $('#tileset').val();

    if (!TILESETS[selectedTileset]) return alert('Invalid tileset');

    $('#setup').hide();
    $('#toolbar').css('display', 'flex');
    $('#map').css({
      display: 'grid',
      gridTemplateColumns: `repeat(${width}, ${tileSize}px)`,
      gridTemplateRows: `repeat(${height}, ${tileSize}px)`
    });
    $('#mapTitle').text(`${name} (${selectedTileset})`);

    const tileset = TILESETS[selectedTileset];
    $('#blockType').empty();
    for (const [key, val] of Object.entries(tileset)) {
      $('#blockType').append(`<option value="${key}">${val.name}</option>`);
    }

    $('#tilePreview').css({ width: 128, height: 128 });
    updatePreview();

    // ✅ Create grid of clickable divs
    $('#map').empty();
    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        const $tile = $('<div class="tile"></div>')
          .attr('data-x', x)
          .attr('data-y', y)
          .css({ width: tileSize, height: tileSize });
        $('#map').append($tile);
      }
    }
  });

  function updatePreview() {
    const tileset = TILESETS[selectedTileset];
    const type = $('#blockType').val();
    if (tileset && tileset[type]) {
      $('#tilePreview').css('background-image', `url(${baseURL}${tileset[type].texture})`);
    }
  }

  $('#blockType').on('change', updatePreview);

  // ✅ On tile click
  $('#map').on('click', '.tile', function() {
    const x = $(this).data('x');
    const y = $(this).data('y');
    const type = $('#blockType').val();
    const tileset = TILESETS[selectedTileset];
    if (!tileset[type]) return;

    $(this).css('background-image', `url(${baseURL}${tileset[type].texture})`);

    const tileId = tileset[type].id;
    const existing = map.find(t => t.x === x && t.y === y);

    if (existing) {
      existing.tile = tileId; // update
    } else {
      map.push({ x, y, tile: tileId }); // add new
    }
  });

    
  $('#export').on('click', function() {
    const name = $('#mapName').val();
    const width = parseInt($('#mapWidth').val());
    const height = parseInt($('#mapHeight').val());

    const tileset = TILESETS[selectedTileset];
    const firstTileId = Object.values(tileset)[0].id; // first tile as default

    const fullMap = [];
    for (let y = 0; y < height; y++) {
      for (let x = 0; x < width; x++) {
        const existing = map.find(t => t.x === x && t.y === y);
        const tileId = existing ? existing.tile : firstTileId;

        const tileEntry = Object.values(tileset).find(t => t.id === tileId);
        const tileUrl = tileEntry ? tileEntry.texture : '';

        fullMap.push({
          x,
          y,
          tile: tileId,
          url: tileUrl
        });
      }
    }

    const json = JSON.stringify({
      name,
      tileset: selectedTileset,
      width,
      height,
      data: fullMap
    }, null, 2);

    $('#output').val(json);
    downloadJSON(name + '.json', json);
  });



  function downloadJSON(filename, text) {
    const blob = new Blob([text], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
  }
});

</script>


</body>
</html>
